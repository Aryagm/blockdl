<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaxPool2D Shape Computation Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .test-result { margin: 10px 0; padding: 10px; border: 1px solid #333; background: #2a2a2a; }
        .success { border-color: #00aa00; }
        .error { border-color: #aa0000; color: #ff6666; }
        .title { color: #00aaaa; font-size: 1.2em; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="title">üß™ MaxPool2D Shape Computation Test Results</div>
    <div id="test-results"></div>

    <script>
        // Copy the MaxPool2D implementation from the fixed TypeScript file
        function parseKernelSize(sizeStr) {
            try {
                const cleaned = sizeStr.replace(/[()]/g, '').trim();
                const parts = cleaned.split(',').map(s => parseInt(s.trim()));
                
                if (parts.length === 2 && !parts.some(isNaN)) {
                    return [parts[0], parts[1]];
                }
            } catch {
                // ignore
            }
            return null;
        }

        function maxpool2d_layer(inputShapes, params) {
            if (inputShapes.length !== 1) return null;
            const inputShape = inputShapes[0];
            
            if (inputShape.length !== 3) return null;
            
            const [inputHeight, inputWidth, channels] = inputShape;
            const poolSize = parseKernelSize(String(params.pool_size) || '(2,2)');
            // FIXED: Default strides to pool_size if not provided (MaxPool2D behavior)
            const stridesParam = params.strides || params.pool_size || '(2,2)';
            const strides = parseKernelSize(String(stridesParam));
            const padding = String(params.padding) || 'valid';
            
            if (!poolSize || !strides) return null;
            
            let outputHeight, outputWidth;
            
            if (padding === 'same') {
                outputHeight = Math.ceil(inputHeight / strides[0]);
                outputWidth = Math.ceil(inputWidth / strides[1]);
            } else { // 'valid'
                outputHeight = Math.floor((inputHeight - poolSize[0]) / strides[0]) + 1;
                outputWidth = Math.floor((inputWidth - poolSize[1]) / strides[1]) + 1;
            }
            
            return [outputHeight, outputWidth, channels];
        }

        function runTests() {
            const results = document.getElementById('test-results');
            
            function addResult(title, success, details) {
                const div = document.createElement('div');
                div.className = `test-result ${success ? 'success' : 'error'}`;
                div.innerHTML = `<strong>${success ? '‚úÖ' : '‚ùå'} ${title}</strong><br>${details}`;
                results.appendChild(div);
            }

            // Test 1: Basic MaxPool2D with default strides
            const test1 = maxpool2d_layer([[28, 28, 32]], { pool_size: '(2,2)', padding: 'valid' });
            const test1Expected = [14, 14, 32];
            const test1Success = test1 && test1.length === 3 && 
                                 test1[0] === test1Expected[0] && 
                                 test1[1] === test1Expected[1] && 
                                 test1[2] === test1Expected[2];
            addResult(
                'Basic MaxPool2D (2x2, valid padding)', 
                test1Success,
                `Input: [28,28,32] ‚Üí Output: [${test1?.join(',') || 'null'}] (Expected: [${test1Expected.join(',')}])`
            );

            // Test 2: MaxPool2D with same padding
            const test2 = maxpool2d_layer([[28, 28, 32]], { pool_size: '(2,2)', padding: 'same' });
            const test2Expected = [14, 14, 32];
            const test2Success = test2 && test2.length === 3 && 
                                 test2[0] === test2Expected[0] && 
                                 test2[1] === test2Expected[1] && 
                                 test2[2] === test2Expected[2];
            addResult(
                'MaxPool2D with same padding', 
                test2Success,
                `Input: [28,28,32] ‚Üí Output: [${test2?.join(',') || 'null'}] (Expected: [${test2Expected.join(',')}])`
            );

            // Test 3: MaxPool2D with 3x3 pool size
            const test3 = maxpool2d_layer([[28, 28, 32]], { pool_size: '(3,3)', padding: 'valid' });
            const test3Expected = [9, 9, 32]; // floor((28-3)/3) + 1 = 9
            const test3Success = test3 && test3.length === 3 && 
                                 test3[0] === test3Expected[0] && 
                                 test3[1] === test3Expected[1] && 
                                 test3[2] === test3Expected[2];
            addResult(
                'MaxPool2D with 3x3 pool size', 
                test3Success,
                `Input: [28,28,32] ‚Üí Output: [${test3?.join(',') || 'null'}] (Expected: [${test3Expected.join(',')}])`
            );

            // Test 4: Test the old bug case - no explicit strides
            const test4 = maxpool2d_layer([[28, 28, 32]], { pool_size: '(2,2)' }); // No strides parameter
            const test4Expected = [14, 14, 32];
            const test4Success = test4 && test4.length === 3 && 
                                 test4[0] === test4Expected[0] && 
                                 test4[1] === test4Expected[1] && 
                                 test4[2] === test4Expected[2];
            addResult(
                'MaxPool2D without explicit strides (THE BUG FIX)', 
                test4Success,
                `Input: [28,28,32] ‚Üí Output: [${test4?.join(',') || 'null'}] (Expected: [${test4Expected.join(',')}])`
            );

            // Summary
            const allTests = [test1Success, test2Success, test3Success, test4Success];
            const passedTests = allTests.filter(Boolean).length;
            addResult(
                `SUMMARY: ${passedTests}/${allTests.length} tests passed`, 
                passedTests === allTests.length,
                passedTests === allTests.length ? 
                    'MaxPool2D shape computation is now working correctly! üéâ' :
                    'Some tests failed. There may still be issues with the MaxPool2D implementation.'
            );
        }

        // Run tests when page loads
        runTests();
    </script>
</body>
</html>
